<link rel="import" href="basic-calendar-day.html">

<polymer-element name="calendar-day-moon-phase" extends="basic-calendar-day">

<template>
  <style>
  :host {
    padding: 4px;
  }
  :host #date {
    text-align: right;
  }
  </style>
  <div id="date"></div>
  <div id="moonAge"></div>
  <div id="quarter"></div> 
</template>

<script>
Polymer( "calendar-day-moon-phase", {
  
  dateChanged: function() {
    this.super();

    var date1 = this.date;
    var age1 = this._moonAge( date1 );

    var date2 = new Date( date1.getTime() );
    date2.setDate( date2.getDate() + 1 ); // Increment date.
    var age2 = this._moonAge( date2 );

    this.$.moonAge.textContent = age1;

    var phase = 29.530588853;
    var quarterNew = 0;
    var quarterFirst = phase / 4;
    var quarterFull = phase / 2;
    var quarterLast = phase * 3/4;

    if ( age1 <= quarterNew && quarterNew < age2 || 
        age1 >= quarterLast && age2 < quarterFirst ) {
      quarter = "New";
    } else if ( age1 <= quarterFirst && quarterFirst < age2 ) {
      quarter = "First";
    } else if ( age1 <= quarterFull && quarterFull < age2 ) {
      quarter = "Full";
    } else if ( age1 <= quarterLast && quarterLast < age2 ) {
      quarter = "Last";
    } else {
      quarter = "";
    }

    this.$.quarter.textContent = quarter;
  },

  // Return the age of the moon (the number of days into a lunar cycle).
  _moonAge: function( date ) {

    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();

    var YY = 0;
    var MM = 0;
    var K1 = 0; 
    var K2 = 0; 
    var K3 = 0;
    var JD = 0;
    var IP = 0;
    var DP = 0;
    var NP = 0;
    var RP = 0;
    
    // calculate the Julian date (midnight UTC)
    YY = year - Math.floor( ( 12 - month ) / 10 );
    MM = month + 9;
    if( MM >= 12 ) MM = MM - 12;
    
    K1 = Math.floor( 365.25 * ( YY + 4712 ) );
    K2 = Math.floor( 30.6 * MM /* + 1 */ /* + 0.5 */ );
    K3 = Math.floor( Math.floor( ( YY / 100 ) + 49 ) * 0.75 ) - 38;
    
    JD = K1 + K2 + day + 59;                  // for dates in Julian calendar
    if( JD > 2299160 ) JD = JD - K3;        // for Gregorian calendar
        
    // calculate moon's age in days
    IP = this._normalize( ( JD - 2451550.1 ) / 29.530588853 );
    AG = IP*29.53;

    return AG;
  },

  // normalize values to range 0...1    
  _normalize: function( v ) {
    v = v - Math.floor( v );
    if ( v < 0 ) {
      v = v + 1;
    }
    return v;
  }

});
</script>

</polymer-element>
