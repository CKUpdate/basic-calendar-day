<link rel="import" href="../basic-calendar-day.html">

<polymer-element name="calendar-day-moon-phase" extends="basic-calendar-day">

<template>
  <style>
  :host {
    padding: 4px;
  }
  :host #date {
    text-align: right;
  }
  </style>
  <div id="date"></div>
  <div id="moonAngle"></div>
  <div id="quarter"></div>
</template>

<script>
Polymer( "calendar-day-moon-phase", {
  
  dateChanged: function() {
    this.super();

    var date1 = this.date;
    var moonAngle1 = this.moonAngle( date1 );
    this.$.moonAngle.textContent = moonAngle1;

    var date2 = new Date( date1.getTime() );
    date2.setDate( date2.getDate() + 1 ); // Increment date.
    var moonAngle2 = this.moonAngle( date2 );

    // var phase = 29.530588853;
    // var quarterNew = 0;
    // var quarterFirst = phase / 4;
    // var quarterFull = phase / 2;
    // var quarterLast = phase * 3/4;

    // if ( age1 <= quarterNew && quarterNew < age2 || 
    //     age1 >= quarterLast && age2 < quarterFirst ) {
    //   quarter = "New";
    // } else if ( age1 <= quarterFirst && quarterFirst < age2 ) {
    //   quarter = "First";
    // } else if ( age1 <= quarterFull && quarterFull < age2 ) {
    //   quarter = "Full";
    // } else if ( age1 <= quarterLast && quarterLast < age2 ) {
    //   quarter = "Last";
    // } else {
    //   quarter = "";
    // }

    // this.$.quarter.textContent = quarter;
  },

  // moonAngle calculates the Moon position, based on Meeus chapter 45
  // and the illuminated percentage from Meeus equations 46.4 and 46.1.
  moonAngle: function( date ) {
    var jd = this._jd0( date.getFullYear(), date.getMonth() + 1, date.getDate() );
    var T=(jd-2451545.0)/36525;
    var T2=T*T;
    var T3=T2*T;
    var T4=T3*T;
    // Moons mean longitude L'
    var LP=218.3164477+481267.88123421*T-0.0015786*T2+T3/538841.0-T4/65194000.0;
    // Moons mean elongation
    var D=297.8501921+445267.1114034*T-0.0018819*T2+T3/545868.0-T4/113065000.0;
    // Suns mean anomaly
    var M=357.5291092+35999.0502909*T-0.0001536*T2+T3/24490000.0;
    // Moons mean anomaly M'
    var MP=134.9633964+477198.8675055*T+0.0087414*T2+T3/69699.0-T4/14712000.0;
    // phase angle
    var pa=180.0-D-6.289*this._sind(MP)+2.1*this._sind(M)-1.274*this._sind(2*D-MP)
           -0.658*this._sind(2*D)-0.214*this._sind(2*MP)-0.11*this._sind(D);
    return this._rev(pa);
  },

  // The Julian date at 0 hours UT at Greenwich
  _jd0: function(year,month,day) {
    var y  = year;
    var m = month;
    if (m < 3) {m += 12; y -= 1};
    var a = Math.floor(y/100);
    var b = 2-a+Math.floor(a/4);
    var j = Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+b-1524.5;
    return j;
  },

  // Extensions to the Math routines - Trig routines in degrees
  _rev: function( angle ) {
    return angle-Math.floor(angle/360.0)*360.0;
  },
  _sind: function( angle ) {
    return Math.sin((angle*Math.PI)/180.0);
  },

});
</script>

</polymer-element>
